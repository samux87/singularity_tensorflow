Bootstrap: docker
From: tensorflow/tensorflow:1.13.1-gpu-py3-jupyter

%post
  # sessions and windows in shell
  apt install -y tmux

  # with only pip install,
  # opencv will fail on import unable to link libs
  pip install opencv-python
  apt update && apt install -y libsm6 libxext6 libxrender-dev

  # install other pip packages
  pip install imshowtools imageio imutils
  pip install sklearn scikit-image
  pip install jupyter_contrib_nbextensions
  pip install keras

  # handy tool to expose only
  # certain number of GPUs
  # via $CUDA_VISIBLE_DEVICES
  pip install mask-gpu

%labels
  Author Saravanabalagi Ramachandran
  Email saravanabalagi@hotmail.com
  Repo https://github.com/saravanabalagi/singularity_tensorflow
  Version v0.1

%help

  This is a tensorflow-gpu 1.13.1 jupyter container forked from docker://tensorflow/tensorflow:1.13.1-gpu-py3-jupyter.

  Further it comes installed with the following primary pip packages:
    opencv-python
    imshowtools
    imageio
    imutils
    sklearn
    scikit-image
    jupyter_contrib_nbextensions
    keras

  For more info, visit https://github.com/saravanabalagi/singularity_tensorflow

##############################
# jupyter app start
##############################

%appenv jupyter
  XDG_RUNTIME_DIR=~/.jupyter/tmp
  export XDG_RUNTIME_DIR

%apphelp jupyter

  =================
  Jupyter App help
  =================
  This app servers Jupyter Notebook at `/jupyter`

  You will have to manually bind your notebook folder at `/jupyter` using
    `--bind /your/files/location:/jupyter`

  Example:
    `singularity run --nv --bind ~/Projects/Python/pspnet:/jupyter --app jupyter tensorflow-1.13.sif`

  =============
  More Info:
  =============
  This app will create a temporary folder in your host machine at
    `~/.jupyter/tmp`

  To bind additional folders for convenience, for example.
    `--bind /your/dataset/location:/data`

  Remember to bind Nvidia libs using `--nv` when you run the app to utilize the GPU.

%apprun jupyter

  # First things first
  # Set $CUDA_VISIBLE_DEVICES
  # Temporary hack, to be set in SLURM
  CUDA_VISIBLE_DEVICES="$@"
  export CUDA_VISIBLE_DEVICES
  echo 'Setting CUDA_VISIBLE_DEVICES...'
  echo "CUDA_VISIBLE_DEVICES=$CUDA_VISIBLE_DEVICES"

  # Build the command to run
  datetime=$(date +'%Y%m%d_%H%M%S')
  filename="$XDG_RUNTIME_DIR/output_$datetime.log"
  tmuxCommand="jupyter notebook --notebook-dir=/jupyter --no-browser |& tee $filename"

  # Pass the command to tmux as a string
  # WARNING! Local/Env variables become null inside tmux
  # DONT remove the double quotes after -d in tmux command
  echo 'Starting Jupyter Notebook Server...'
  tmux new -d "$tmuxCommand"

  echo 'Waiting for the logfile to be created...'
  while [ ! -f $filename ]; do
    sleep 1;
  done
  printf "Log file has been created at\n  $filename"

  # Show additional details
  printf "\n\n==================================================\n"
  echo 'If the notebook link is not printed below,'
  echo 'please run notebook_list.sh to get all jupyter sessions'
  echo 'For more information, see the logfile'
  printf "==================================================\n\n"

  # Wait for the server to start
  # And print lines when logfile contains more than 5 lines
  printf "\n==================================================\n"
  echo "Printing first few lines of the logfile"
  printf "==================================================\n\n"
  while [ $(cat $filename | wc -l) -le 5 ]; do
    sleep 1;
  done
  sleep 1; cat $filename
  printf "==================================================\n\n"

##############################
# jupyter app end
##############################
